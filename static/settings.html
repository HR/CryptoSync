<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Settings</title>
	<link rel="stylesheet" href="style/settings.css">
</head>

<body>
	<section id="settings">
		<div class="panel-container">
			<div class="menu">
				<a class="item navigationLink active" data-target="accounts">Accounts</a>
				<a class="item navigationLink" data-target="crypto">Crypto</a>
				<a class="item navigationLink" data-target="sync">Sync</a>
				<a class="item navigationLink" data-target="contribute">
					<img class="icon" src="images/icons/mark-github.svg" alt="" />
				</a>
				<a class="item right">
					<img class="icon" src="images/icons/CryptoSyncVault_sl.svg" alt="" />
				</a>
			</div>
			<div id="panel-accounts" class="current">
				<section class="accounts">
					<header>
						<img class="icon" src="images/icons/accounts.svg" alt="" />
						<h3>Cloud accounts</h3>
					</header>
					<div class="list">
						<div class="item">
							<div class="type">
								<div class="profile"></div>
								<div class="cloudType">
									<img src="images/icons/gdrive.svg"></img>
								</div>
							</div>
							<div class="content">
								<div class="name">Nikola Tesla</div>
								<div class="lastMod">nikola.tesla@gmail.com</div>
								<div class="qouta">5.76GB / 15GB</div>
							</div>
							<img src="images/icons/remove.svg" alt="" class="icon remove right" />
						</div>
						<div class="item">
							<div class="type">
								<div class="profile"></div>
								<div class="cloudType">
									<img src="images/icons/dropbox_stroke.svg"></img>
								</div>
							</div>
							<div class="content">
								<div class="name">Nikola Tesla</div>
								<div class="lastMod">nikola.tesla@gmail.com</div>
								<div class="qouta">520.5 MB / 2GB</div>
							</div>
							<img src="images/icons/remove.svg" alt="" class="icon remove right" />
						</div>
					</div>
					<button class="button add">
						<img src="images/icons/add.svg" alt="" class="icon" />
					</button>
				</section>
			</div>
			<div id="panel-crypto">
				<section class="crypto">
					<header>
						<img class="icon" src="images/icons/crypto.svg" alt="">
						<h3>Crypto</h3>
					</header>
					<section class="category">
						<h4>Encryption</h4>
						<div class="options">
							<div class="option">
								<span>Key Length</span>
								<select class="right config" data-config="keyLength">
									<option value="128">128-bit</option>
									<option value="256">256-bit</option>
								</select>
							</div>
							<div class="option">
								<span>Algorithm</span>
								<select class="right config" data-config="algorithm">
									<option value="CTR">CTR</option>
									<option value="CBC">CBC</option>
								</select>
							</div>
							<div class="option">
								<span>Randomness</span>
								<select class="right config" data-config="randomness">
									<option value="pseudo">Pseudo</option>
									<option value="true">True (experimental)</option>
								</select>
							</div>
						</div>
					</section>
					<section class="category">
						<h4>Vault</h4>
						<div class="options">
							<div class="option">
								<span>Encryption key length</span>
								<select class="right config" data-config="MPkeyLength">
									<option value="128">128-bit</option>
									<option value="256" selected>256-bit</option>
								</select>
							</div>
						</div>
					</section>
					<section class="category">
						<h4>MasterPass</h4>
						<div class="options">
							<div class="option">
								<span>Shares</span>
								<select class="right config" data-config="shares">
									<option value="s2n3">s = 2, n = 3</option>
									<option value="s2n4">s = 2, n = 4</option>
								</select>
							</div>
							<div class="option">
								<img class="info" src="images/icons/info.svg" alt="">
								<p class="info">Where n = Number of shares required to reconstruct MasterPass and S = Total number of shares</p>
							</div>
							<div class="option">
								<span>Change</span>
								<button class="right" id="resetMasterPass">Reset</button>
							</div>
						</div>
					</section>
				</section>
			</div>
			<div id="panel-sync">
				<section class="sync">
					<header>
						<img class="icon" src="images/icons/sync.svg" alt="" />
						<h3>Sync</h3>
					</header>
					<section class="category">
						<h4>General</h4>
						<div class="options">
							<div class="option">
								<span>Autostart</span>
								<input type="checkbox" class="right config" data-config="autostart" checked/>
							</div>
							<div class="option">
								<span>Encrypt while offline</span>
								<input type="checkbox" class="right config" data-config="offlineEnc" checked/>
							</div>
							<div class="option">
								<span>Location</span>
							</div>
						</div>
					</section>
				</section>
			</div>
			<div id="panel-contribute">
				<section class="contribute">
					<header>
						<img class="icon" src="images/icons/mark-github.svg" alt="" />
						<h3>Contribute</h3>
					</header>
					<div class="list">
						<div class="item">
							<a class="navigationLink" data-target="https://github.com/HR/CryptoSync/issues">
								<img src="images/icons/issue-opened.svg" class="icon" alt="" />
								<div class="name">
									Report an issue / Give feedback
								</div>
							</a>
						</div>
						<div class="item">
							<a class="navigationLink" data-target="https://github.com/HR/CryptoSync">
								<img src="images/icons/star.svg" alt="" class="icon" />
								<div class="name">
									Star the repo
								</div>
							</a>
						</div>
						<div class="item">
							<a class="navigationLink" data-target="https://github.com/HR/CryptoSync/fork">
								<img src="images/icons/repo-forked.svg" alt="" class="icon" />
								<div class="name">
									Fork the repo
								</div>
							</a>
						</div>
						<div class="item">
							<a class="navigationLink" data-action="checkUpdates">
								<img src="images/icons/package.svg" alt="" class="icon" />
								<div class="name">
									Check for Updates
								</div>
							</a>
						</div>
					</div>
					<footer>
						<img src="images/icons/code.svg" alt="" class="icon" /> with
						<img src="images/icons/heart.svg" alt="" class="icon" /> by
						<br><a class="navigationLink" data-target="https://github.com/HR">Habib Rehman</a>
					</footer>
				</section>
			</div>
		</div>
	</section>
	<script type="text/javascript">
	// TODO: Add reset config feature
		window.$ = window.jQuery = require('jquery');
		// load core modules first
		var remote = require('electron').remote,
			gAuth = remote.getGlobal('gAuth'),
			ipcRenderer = require('electron').ipcRenderer,
			remoteWin = remote.getCurrentWindow(),
			settings = remote.getGlobal("settings"),
			mdb = remote.getGlobal("mdb"),
			rconsole = remote.getGlobal("console"),
			shell = require('shell'),
			prr = require('prr'),
			webContents = remoteWin.webContents;
		userSettings = {};

		/* Network change event */
		function updateOnlineStatus() {
			ipcRenderer.send('online-status-changed', navigator.onLine ? 'online' : 'offline');
		};
		$(window).on('online', updateOnlineStatus);
		$(window).on('offline', updateOnlineStatus);
		updateOnlineStatus();
		$(window).load(function() {
			// attach click listners
			$(document).on("click", "#resetMasterPass", function(){
				ipcRenderer.send("resetMasterPass");
			});
			$(".navigationLink").each(function(index) {
				$(this).click(function() {
					var target = this.getAttribute("data-target"),
							action = this.getAttribute("data-action");
					$(".active").first().removeClass("active");
					$("a[data-target='" + target + "']").addClass("active");
					if (action) {
						// TODO: Action (i.e. check for updates/open updater)
						console.log(`${this} has data-action attr`);
						ipcRenderer.send(action);
						return;
					}
					navigate(target);
				});
			});

			$(".config").each(function(index) {
				var $this = $(this);
				if (!($.isEmptyObject(settings.user))) {
					// TODO: Load defaults
					console.log("settings.user is not empty");
					setConfig(settings.user);
				}
				$this.change(function() {
					var config = this.getAttribute("data-config");
					var isCheckbox = $this.is(':checkbox');
					var value = (isCheckbox) ? $this.is(':checked') : $this.val();
					rconsole.log(`RENDER: ${config} has changed to ${value} of type ${typeof value}`);
					userSettings[config] = value;
					rconsole.log(`RENDER: Set userSettings[${config}] to ${userSettings[config]}`);
					settings.user = userSettings;
				});
			});
		});

		function setConfig (configObj) {
			for (var config in configObj) {
				if (configObj.hasOwnProperty(config)) {
					var value = configObj[config];
					if ($.type(value) === "boolean") {
						$("[data-config='" + config + "']").prop('checked', value);
					} else {
						$("[data-config='" + config + "']").val(value);
					}
				}
			}
		}
		function navigate(dest) {
			var URLregex = /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;
			if (URLregex.test(dest)) {
				shell.openExternal(dest);
				return;
			}
			var oldSel = $('.panel-container > div.current');
			var currSel = $("#panel-" + dest);
			if (oldSel) oldSel.removeClass("current");
			$("#panel-" + dest).addClass("current");
		}
	</script>
</body>

</html>
