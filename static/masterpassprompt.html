<html>

<head>
	<meta charset="utf-8">
	<title>Unlock the Vault</title>
	<link rel="stylesheet" href="style/masterpassprompt.css" charset="utf-8">
	<!-- <script language="javascript" type="text/javascript" src="js/handle.js"></script> -->
</head>

<body>
	<!-- CS Menubar v1f -->
	<section id="masterpassprompt">
		<img src="images/icons/CryptoSyncvault.svg" alt="some" id="vault" />
		<div class="panel-container">
			<div id="panel-default">
				<header>
					<h1>Unlock the Vault</h1>
					<p>Please enter your Master Password to unlock the vault
					</p>
					<img class="info" src="images/icons/info.svg" alt="" />
					<p class="info">The Vault that contains all the secret keys for your encrypted data is encrypted using a Master Password - your MasterPass</p>
				</header>
				<form onsubmit="return false;">
					<div class="masterpass">
						<input type="password" name="masterpass" id="masterpass" placeholder="********" />
						<label for="password">INCORRECT MASTER PASSWORD</label>
					</div>

					<div class="forgotMP">
						<a class="navigationLink" data-target="reset">Forgot MasterPass?</a>
					</div>

					<div class="submit">
						<input type="submit" value="Unlock" id="setMasterPass"/>
					</div>
				</form>
				<footer>
					<a class="navigationLink right" data-target="shares">Got shares?</a>
				</footer>
			</div>
			<div id="panel-shares">
				<header>
					<h1>Unlock the Vault</h1>
					<p>Please enter your Secret Shares to unlock the vault
					</p>
					<img class="info" src="images/icons/info.svg" alt="" />
					<p class="info">The Vault that contains all the secret keys for your encrypted data is encrypted using a Master Password - your MasterPass - constructed using your secret shares</p>
				</header>
				<form onsubmit="return handleShareSubmit()">
					<div class="masterpass">
						<input type="password" name="share" class="" placeholder="********" required/>
						<input type="password" name="share" class="" placeholder="********" required/>
						<input type="password" name="share" class="" placeholder="********" required/>
						<input type="password" name="share" class="" placeholder="********" required/>
						<label for="password">INCORRECT SECRET SHARES(S)</label>
					</div>
					<div class="submit">
						<input type="submit" value="Unlock" />
					</div>
				</form>
				<footer>
					<a class="back navigationLink" data-target="default">
						<img src=" images/icons/back.svg" alt=" " />
					</a>
				</footer>
			</div>
			<div id="panel-reset">
				<header>
					<h1>Reset the MasterPass</h1>
					<p>Please enter a new secure MasterPass
					</p>
					<img class="info" src="images/icons/info.svg" alt=" " />
					<p class="info ">The MasterPass is used to encrypt the Vault. Thus, the strength of the Vault relies on the strength of your password. Resetting your password will prompt the re-encryption of all the data and discard the former encrypted</p>
				</header>
				<form onsubmit="handleReset(); return false;">
					<div class="masterpass">
						<input type="password" name="name" id="name" placeholder="********" required/>
					</div>

					<div class="submit">
						<input type="submit" value="Reset" />
					</div>
				</form>
				<footer>
					<a href="#" class="back navigationLink" data-target="default">
						<img src="images/icons/back.svg" alt="" />
					</a>
				</footer>
			</div>
		</div>
	</section>
	<script type="text/javascript">
		var ipcRenderer = require('electron').ipcRenderer,
				rconsole = require('electron').remote.getGlobal("console"),
				errLabelCheckMP;
		window.$ = window.jQuery = require('jquery');

		function updateOnlineStatus() {
			ipcRenderer.send('online-status-changed', navigator.onLine ? 'online' : 'offline');
		};
		$(window).on('online', updateOnlineStatus);
		$(window).on('offline', updateOnlineStatus);
		updateOnlineStatus();

		navigate("default");
		$(window).load(function() {
			errLabelCheckMP = $('label[for="password"]').first();
			errLabelCheckMP.hide();
			$(".navigationLink").each(function(index) {
				$(this).click(function() {
					navigate(this.getAttribute("data-target"));
				});
			});
			$("#setMasterPass").click(function() {
				console.log("setMasterPass button clicked");
				var MPregex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{8,}$/g,
					MasterPass = $("input#masterpass").val();
				if (MPregex.test(MasterPass)) {
					errLabelCheckMP.hide();
					ipcRenderer.send("checkMasterPass", MasterPass);
				} else if (!MasterPass) {
					errLabelCheckMP.text("please enter a masterpass".toLocaleUpperCase());
					errLabelCheckMP.show();
				} else {
					errLabelCheckMP.text("Invalid password".toLocaleUpperCase());
					errLabelCheckMP.show();
				}
			});
		});

		function navigate(panelID) {
			var oldSelection = $('.panel-container > div.current');
			if (oldSelection) oldSelection.removeClass("current");
			$("#panel-" + panelID).addClass("current");
		}

		ipcRenderer.on('checkMasterPassResult', function (event, result) {
			if (result.err) {
				errLabelCheckMP.text(`ERROR: ${err}`);
				errLabelCheckMP.show();
				return;
			}

			if (result.match) {
				// TODO: show confirmation
				errLabelCheckMP.text(`CORRECT PASSWORD`);
				errLabelCheckMP.css('color', '#2ECC71');
				errLabelCheckMP.show();
				return;
			} else {
				errLabelCheckMP.text(`INCORRECT PASSWORD`);
				errLabelCheckMP.show();
				return;
			}
		});
	</script>
</body>
</html>
