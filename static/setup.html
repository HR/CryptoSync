<html>

<head>
	<meta charset="utf-8">
	<title>Crypto.Sync Setup</title>
	<link rel="stylesheet" href="style/setup.css" charset="utf-8">
	<!-- <script language="javascript" type="text/javascript" src="js/handle.js"></script> -->
</head>

<body>
	<!-- CS Setup UI v1f -->
	<section id="setup">
		<div class="panel-container">
			<div id="panel-default">
				<header>
					<div class="banner">
						<div class="backtext" id="encrypted">It is a long established fact that a reader w
							<br/>ill be distracted by the readable content of
							<br/>a page when looking at its layout. The point
							<br/>of using Lorem Ipsum is that it has a more-or
							<br/>-less normal distribution of letters, as oppo</div>
						<img src="images/icons/CryptoSync.svg" alt="some" class="himg" />
						<div class="backtext" id="decrypted">KlZ7wkieedArq7w9YsHe++D1ZAnNdL91OvBbV1LnX8f19
							<br/>YjrsCojOnycYERhd56hl8v4lAquhLYfk71Vf2tZd7JbNR
							<br/>C8pLOJQxAFbCP+HZPAt6Kz5hO0Ir3SWJNxxAAN/GS7Pbx
							<br/>coOJAHLO4b+vHBOS0XniqSXpOcyQPTgFEJmjcHhvtjfLT
							<br/>VxzOxu6EN40pjvK8oAf7041D+cWR+PDH6LnlCik2hnmFK</div>
					</div>
					<h1>Welcome to Crypto.Sync</h1>
					<p>Crypto.Sync an end-to-end encryption cloud synchronisation client that simply manages the encryption of your cloud data for you.
					</p>
				</header>
				<button class="fancy" class="navigationLink" onclick="navigate(this.getAttribute('data-target'))" data-target="accounts">GET STARTED</button>
			</div>
			<div id="panel-accounts">
				<section class="accounts">
					<header>
						<div class="banner">
							<img class="himg" src="images/icons/csp_accounts.svg" alt="" />
						</div>
						<h1>Add a Cloud Service Account</h1>
					</header>
					<div class="list">
						<div class="item">
							<a class="navigationLink" data-target="auth" data-auth="gdrive">
								<img src="images/icons/gdrive.svg" />
								<div class="name">Google Drive</div>
								<img src="images/icons/foward.svg" alt="" class="icon right" />
							</a>
						</div>
						<div class="item">
							<a class="navigationLink" data-target="auth" data-auth="dropbox">
								<img src="images/icons/dropbox.svg" />
								<div class="name">Dropbox</div>
								<img src="images/icons/foward.svg" alt="" class="icon right" />
							</a>
						</div>
						<div class="item err">
							<div class="name"></div>
						</div>
					</div>
				</section>
				<footer>
					<a href="#" class="back navigationLink" data-target="default">
						<img src="images/icons/back.svg" alt="" />
					</a>
				</footer>
			</div>
			<!-- START: INJECT INTO BROWSER CONTENT -->
			<div id="panel-auth">
				<header class="minimal">
					<div class="banner">
						<svg class="spinner" width="65px" height="65px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
							<circle class="path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle>
						</svg>
					</div>
					<h1>Authorising...</h1>
				</header>
				<!-- <footer>
					<a href="#" class="back navigationLink" data-target="accounts">
						<img src="images/icons/back.svg" alt="" />
					</a>
				</footer> -->
			</div>
			<!-- END: INJECT INTO BROWSER CONTENT -->
			<div id="panel-masterpass">
				<section id="masterpassprompt">
					<header>
						<div class="banner">
							<img class="himg" src="images/icons/CryptoSyncVault.svg" alt="" />
						</div>
						<h1>Set a MasterPass</h1>
						<img class="info" src="images/icons/info.svg" alt="" />
						<p class="info">The Vault that contains all the secret keys for your encrypted data is encrypted using a Master Password - your MasterPass</p>
					</header>
					<form action="#">
						<div class="masterpass">
							<input type="password" name="name" id="name" class="" placeholder="********" />
							<label for="password">INCORRECT MASTER PASSWORD</label>
						</div>

					</form>
					<button class="fancy">SET</button>
					<p class="note">DO NOT lose your MasterPass! Please Store it safely.
						<br/>If lost, all previously synced data will be unrecoverable!</p>
				</section>
				<footer>
					<a href="#" class="back navigationLink" data-target="accounts">
						<img src="images/icons/back.svg" alt="" />
					</a>
				</footer>
			</div>
			<div id="panel-done">
				<header>
					<div class="banner">
						<img src="images/icons/done.svg" class="himg" />
					</div>
					<h1>All done!</h1>
					<p>You have successfully setup Crypto.Sync. It will shortly start doing its magic and protecting your privacy.</p>
				</header>
				<button class="fancy" class="done navigationLink">FINISH</button>
				<footer class="credit">
					<img src="images/icons/code.svg" alt="" class="icon" /> with
					<img src="images/icons/heart.svg" alt="" class="icon" /> by <a onclick="event.preventDefault();require('shell').openExternal('https://git.io/HR');">Habib Rehman</a>
				</footer>
			</div>
		</div>
	</section>
	<script type="text/javascript">
		window.$ = window.jQuery = require('jquery');
		var OAuth = require('../src/auth.js'),
				remote = require('electron').remote,
				ipcRenderer = require('electron').ipcRenderer,
				remoteWin = remote.getCurrentWindow(),
				paths = remote.getGlobal("paths"),
				views = remote.getGlobal("views"),
				mdb = remote.getGlobal("mdb"),
				rconsole = remote.getGlobal("console"),
				webContents = remoteWin.webContents,
				authErr = $("div.item.err > div.name").first(),
				panel = (getParam("nav_to", window.document.URL)) ? getParam("nav_to", window.document.URL) : "default";

		navigationLinks = $('.navigationLink');
		navigationLinks.each(function(index) {
			$(this).click(function() {
				if (this.hasAttribute("data-auth")) navigate(this.getAttribute("data-target"), this.getAttribute("data-auth"));
				navigate(this.getAttribute("data-target"));
			});
		});

		navigate(panel);

		function navigate(panelID, authType) {
			var oldSel = $('.panel-container > div.current');
			var currSel = $("#panel-" + panelID);
			if (authType) {
				console.log("authType: " + authType);
				authErr.hide();
				initAuth(authType);
			}
			if (oldSel) oldSel.removeClass("current");
			$("#panel-" + panelID).addClass("current");
		}

		function getParam(name, url) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(url);
			return (results === null) ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		function initAuth(authType) {
			if (authType === "gdrive") {
				OAuth.authorize(paths.userData + "/client_secret.json", mdb, function(authUrl, callback) {
					rconsole.log("Loading authUrl... " + authUrl);
					remoteWin.loadURL(authUrl);
					// IPCWAIT
					// callback(err, token);
				})
			}
		}

		ipcRenderer.on("auth-result", function(event, url) {
			rconsole.log("IPCRENDER auth-result emitted,\n URL: " + url + "\n");
			// code to get AUTH CODE
			var err = getParam("error", url);
			// if error then callback URL is http://localhost/?error=access_denied#
			// if sucess then callback URL is http://localhost/?code=2bybyu3b2bhbr
			if (!err) {
				var code = getParam("code", url);
				rconsole.log("Got the AUTH CODE: " + code);
				rconsole.log("Calling callback with the code...");
				// Send code to call back and redirect
				// callback(code, function(err, authed) {
				// 	// body...
				// });
				navigate("auth");
			} else if (err === "access_denied") {
				// if err === access_denied check
				rconsole.log("ERR: access_denied");
				authErr.text("Access to your account was denied. Please try again.");
				authErr.show();
				navigate("accounts");
			} else {
				rconsole.log("ERR: unknown, " + err);
				authErr.text("Unknown error: " + err);
				authErr.show();
				navigate("accounts");
			}
		});
		// var current = $("div.current");
		//
		// function handleSubmit() {
		// 	var MasterPass = current.find("#masterpass"),
		// 			label = current.find("div.masterpass > label");
		// 	console.log("MasterPass: "+MasterPass.val());
		// 	if(!(MasterPass.val())) {
		// 		MasterPass.addClass("invalid");
		// 		label.html("EMPTY MASTERPASS");
		// 		label.css("display", "block");
		// 		label.css("color", "#9F3A38");
		// 	} else {
		// 		// TO DO: Send another arg to distinguish input type
		// 		// (i.e. masterpass, shares, reset)
		// 		ipcRenderer.sendSync('masterpass-submission', MasterPass.val(), current.attr('id'));
		// 		label.html("INCORRECT MASTERPASS");
		// 		MasterPass.removeClass("invalid")
		// 		current.find("div.masterpass > label").css("display", "none");
		// 	}
		// }
	</script>
</body>

</html>
